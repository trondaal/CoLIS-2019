<?xml version="1.0" encoding="UTF-8"?>
<templates 
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:noNamespaceSchemaLocation="../../marc2entities/xsd/marc2lrm.rules.xsd">
    <!-- keyfilter is used to remove punctuation etc. from the values that are used in the keystring -->
    <keyfilter>replace($key, ' ', '')</keyfilter>

    <!-- **************************--> 
    <!--          100 Field        -->
    <!-- **************************--> 
  
    <entity tag="100" condition="not(*:subfield/@code = '4')" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-100-Person-No-Code" label="Person No relator code">
        <note>Creator identified with the help of field 100</note>
        <attributes>
            <datafield tag="100">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='100'])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-130240-Work"/>   
                <!--<target entity="MARC21-700-Work-Analytical"/>  -->
            </relationship>
        </relationships>
    </entity> 
    
    <entity tag="100" code="4" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-100-Person" label="Person">
        <note>Creator identified with the help of field 100</note>
        <attributes>
            <datafield tag="100">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='100'])</element>
        </key>
        <relationships>           
            <relationship condition="$relmap/rels/rel[$this_subfield = k and domain='Work']" type="{$relmap/rels/rel[k = $this_subfield and domain='Work']/reverse}" itype="{$relmap/rels/rel[k = $this_subfield  and domain='Work']/forward}">
                <!--<target entity="MARC21-700-Work-Analytical"/>-->
                <target entity="MARC21-130240-Work"/>
            </relationship>
            <relationship condition="$relmap/rels/rel[$this_subfield = k and domain='Expression']" type="{$relmap/rels/rel[k = $this_subfield and domain='Work']/reverse}" itype="{$relmap/rels/rel[k = $this_subfield  and domain='Expression']/forward}">
                <target entity="MARC21-700-Expression-Analytical"/>
                <target entity="MARC21-130240-Expression"/>
            </relationship>
        </relationships>
    </entity>
    
    <!-- **************************--> 
    <!--    130 / 240 Field        -->
    <!-- **************************--> 
    
    <entity tag="130, 240" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-130240-Work" label="Work">
        <note>Work identified by titles in 130 and 240. For the CoLIS collection we only create works from 240 or 130 if there are no analytical entries</note>
        <attributes>
            <datafield tag="130">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" select="lower-case(.)"  type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="240">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" select="lower-case(.)"  type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" select="lower-case(.)" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag=('130', '240')], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/w/P10078" itype="http://rdaregistry.info/Elements/e/P20231" label="has expression of work" ilabel="has work expressed">
                <target entity="MARC21-130240-Expression" same-field="true"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10261" itype="http://rdaregistry.info/Elements/a/P50249">
                <target entity="MARC21-600-Person" condition="not($target_field/*:subfield/@code = 't')"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10257" itype="http://rdaregistry.info/Elements/w/P10264">
                <target entity="MARC21-600-Work"  condition="not($this_field/*:subfield/@code = '1w') or $this_field/*:subfield[@code = '1w'] ne $target_field/*:subfield[@code = '1w']"/>
            </relationship>
            <relationship type="{$relmap/rels/rel[k = $target_field/*:subfield[@code='4']]/forward}" itype="{$relmap/rels/rel[k = $target_field/*:subfield[@code='4']]/reverse}">
                <target entity="MARC21-700-Work-Related-Work"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="130, 240" condition="count($record/*:datafield[@tag='700' and @ind2 = '2' and *:subfield/@code = 't']) = 0" type="http://rdaregistry.info/Elements/c/C10006" templatename="MARC21-130240-Expression" label="Expression">
        <note>Expression for the title in the 130 or 240, we only create this expression if there is no analytical entries, otherwise we
              assume that it is the parts that are embodied and directly the whole</note>
        <!-- we use 245 as the preferred expression title unless there specifically is a 740 entry -->
        <!-- we code 240/130 as alternative titles  -->
        <attributes>
            <controlfield tag="008"  type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression" select="substring(., 36, 3)"/>
            <!--<datafield tag="041" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="j" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>-->
            <datafield tag="130">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20316" select="frbrizer:trim(.)" label="has variant title"/>
                <subfield code="h" type="http://rdaregistry.info/Elements/e/P20001" select="lower-case(frbrizer:trim(.))" label="has content type"/>
                <subfield code="l" type="http://rdaregistry.info/Elements/e/P20006" select="lower-case(.)" label="has language of expression"/>
            </datafield>
            <datafield tag="240">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20316" select="frbrizer:trim(.)" label="has variant title"/>
                <subfield code="h" type="http://rdaregistry.info/Elements/e/P20001" select="lower-case(frbrizer:trim(.))" label="has content type"/>
                <subfield code="l" select="lower-case(.)" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>
            <datafield tag="245">
                <subfield code="a" type="{if (frbrizer:linked-strict($record/*:datafield[@tag='740'], $record/*:datafield[@tag=('130', '240')])) then 'http://rdaregistry.info/Elements/e/P20316' else 'http://rdaregistry.info/Elements/e/P20315'}" select="frbrizer:trim(.)" label="has variant title"/>
            </datafield>
            <datafield tag="336">
                <subfield code="a" select="lower-case(.)" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
            </datafield>
            <datafield tag="740" condition="frbrizer:linked-strict($anchor_field, .)">
                <subfield code="a" select="frbrizer:trim(.)"  type="http://rdaregistry.info/Elements/e/P20315" label="has preferred title"/>
            </datafield>
        </attributes>
        <label select="string-join((*:datafield[@tag='336']/*:subfield[@code='a'], *:datafield[@tag='041']/*:subfield[@code=('a', 'd')][1]), '/')"/>
        <key order="3">
            <element>(frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/e/P20231']/@href))[1]</element>
            <element>'/'</element>
            <element>lower-case((*:datafield[@tag = ('130', '240')]/*:subfield[@type='http://rdaregistry.info/Elements/e/P20006'], *:controlfield[@tag = '008'][@type='http://rdaregistry.info/Elements/e/P20006'] )[1])</element>
            <element>'/'</element>
            <element>lower-case((*:datafield/*:subfield[@type='http://rdaregistry.info/Elements/e/P20001']/replace(., ' ', ''))[1])</element>
            <element>'/'</element>
            <element>string-join(frbrizer:trimsort-targets(*:relationship[@type =('http://rdaregistry.info/Elements/e/P20037', 'http://rdaregistry.info/Elements/e/P20022', 'http://rdaregistry.info/Elements/e/P20049')]/@href), '/')</element>
            <!--<element>frbrizer:trimsort-targets(*:relationship[$relmap/rels/rel[forward = @type and domain = "Expression"]]/@href)</element>-->
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/e/P20059" itype="http://rdaregistry.info/Elements/m/P30139" label="has manifestation of expression" ilabel="has expression manifested">
                <target entity="MARC21-245-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <!-- **************************--> 
    <!--          245 Field        -->
    <!-- **************************-->  
    
    <entity tag="245" type="http://rdaregistry.info/Elements/c/C10007" templatename="MARC21-245-Manifestation" label="Manifestation">
        <note>Manifestation</note>
        <attributes>
            <controlfield tag="001" type="http://marc21rdf.info/elements/marc/M001"/>
            <datafield tag="020">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30004" select="concat('isbn-', replace(., '\D', ''))" label="has identifier for the manifestation"/>
            </datafield>
            <datafield tag="022">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30004" select="concat('issn-', ./replace(., '\D', ''))" label="has identifier for the manifestation"/>
            </datafield>
            <datafield tag="024">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30004" select="concat(frbrizer:idprefix(../@ind1) ,'-', replace(., '\D', ''))" label="has identifier for the manifestation"/>
            </datafield>
            <datafield tag="245">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30156" select="frbrizer:trim(.)" label="has title proper"/>
                <subfield code="b" type="http://rdaregistry.info/Elements/m/P30142" select="frbrizer:trim(.)" label="has other title information"/>
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30117" select="frbrizer:trim(.)" label="has statement of responsibility"/>
            </datafield>
            <datafield tag="250">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30107" label="has edition statement"/>
            </datafield>
            <datafield tag="260">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30088" select="frbrizer:trim(.)" label="has place of publication"/>
                <subfield code="b" type="http://rdaregistry.info/Elements/m/P30083" select="frbrizer:trim(.)" label="has publisher"/>
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30011" select="frbrizer:trim(.)" label="has date of publication"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/m/P30111" select="frbrizer:trim(.)" label="has publication statement"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/m/P30175" select="frbrizer:trim(.)" label="has manufacturers name"/>
                <subfield code="g" type="http://rdaregistry.info/Elements/m/P30109" select="frbrizer:trim(.)" label="has manufacture statement"/>
            </datafield>
            <datafield tag="264">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30088" select="frbrizer:trim(.)" label="has place of publication"/>
                <subfield code="b" type="http://rdaregistry.info/Elements/m/P30083" select="frbrizer:trim(.)" label="has publisher"/>
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30011" select="frbrizer:trim(.)" label="has date of publication"/>
            </datafield>
            <datafield tag="300">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30182" label="has extent"/>
                <subfield code="b" type="http://marc21rdf.info/elements/marc/M30000b" label="other physical details"/>
                <subfield code="c" type="http://rdaregistry.info/Elements/m/P30169" label="has dimensions"/>
                <subfield code="e" type="http://marc21rdf.info/elements/marc/M30000e" label="accompanying material"/>
            </datafield>
            <datafield tag="337">
                <subfield code="a" select="lower-case(frbrizer:trim(.))" type="http://rdaregistry.info/Elements/m/P30001" label="has carrier type"/>
            </datafield>
            <datafield tag="338">
                <subfield code="a" select="lower-case(frbrizer:trim(.))" type="http://rdaregistry.info/Elements/m/P30002" label="has media type"/>
            </datafield>
            <datafield tag="490">
                <subfield code="a" type="http://rdaregistry.info/Elements/m/P30106" select="frbrizer:trim(.)" label="has series statement"/>
                <subfield code="v" type="http://rdaregistry.info/Elements/m/P30165" label="has numbering of serials"/>
                <subfield code="l" type="http://marc21rdf.info/elements/marc/M49000l"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>if ((*:datafield[@tag=("020","024")][1]/*:subfield[@code='a'])[1]) then (*:datafield[@tag=("020","024")][1]/*:subfield[@code='a'])[1]/replace(., '\(.*\)', '') else *:controlfield[@tag='001']</element>
        </key>
        <relationships>
            <!--<relationship type="http://rdaregistry.info/Elements/m/P30020" itype="http://rdaregistry.info/Elements/m/P30033" label="is contained in (manifestation)" ilabel="is container for (manifestation)">
                <target entity="MARC21-490-Manifestation"/>
                <target entity="MARC21-773-Manifestation"/>
            </relationship>-->
        </relationships>
    </entity>
    
    
    <!-- **************************--> 
    <!--          600 Field        -->
    <!-- **************************-->  
    
    <entity tag="600" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-600-Person" label="Person">
        <note>Person in a subject entry</note>
        <attributes>
            <datafield tag="600">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='600'])</element>
        </key>
        <relationships>           
            <relationship type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-600-Work" same-field="true"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="600" condition="*:subfield/@code = 't'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-600-Work" label="Work">
        <note>Work identified by title in 600</note>
        <attributes>
            <datafield tag="600">
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" select="lower-case(.)" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='600'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
    </entity>
    
    
    <!-- **************************--> 
    <!--          700 Field        -->
    <!-- **************************--> 
  
    <!-- Analytical entries -->
    
    <entity tag="700" condition="@ind2 = '2'" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-700-Person-Analytical" label="Person">
        <note>Person in 700 field </note>
        <attributes>
            <datafield tag="700">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="4" type="relator code"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='700'])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-700-Work-Analytical" same-field="true"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="700" condition="@ind2='2'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-700-Work-Analytical" label="Work">
        <note>Analytical work</note>
        <attributes>
            <datafield tag="700" >
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" select="lower-case(.)"  type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
            <datafield tag="380" condition="frbrizer:linked($anchor_field, .)">
                <subfield code="a" type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='700'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/w/P10019" itype="http://rdaregistry.info/Elements/w/P10147" label="part of work">
                <target entity="MARC21-130240-Work"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10078" itype="http://rdaregistry.info/Elements/e/P20231" label="has expression of work" ilabel="has work expressed">
                <target entity="MARC21-700-Expression-Analytical" same-field="true"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10261" itype="http://rdaregistry.info/Elements/a/P50249">
                <target entity="MARC21-600-Person" condition="not($target_field/*:subfield/@code = 't')"/>
            </relationship>
            <relationship type="http://rdaregistry.info/Elements/w/P10257" itype="http://rdaregistry.info/Elements/w/P10264">
                <target entity="MARC21-600-Work"  condition="$this_field/*:subfield[@code = '1w'] ne $target_field/*:subfield[@code = '1w']"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="700" condition="@ind2='2'" type="http://rdaregistry.info/Elements/c/C10006" templatename="MARC21-700-Expression-Analytical" label="Expression">
        <note>Expression associated with work identified by 700$t (only creating expressions for analytical entries)</note>
        <attributes>
            <controlfield tag="008"  type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression" select="substring(., 36, 3)"/>
            <!-- <datafield tag="041" condition="frbrizer:linked($anchor_field, .) and not(exists($anchor_field/*:subfield[@code = 'l']))">
                <subfield code="a" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="e" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="j" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
            </datafield>-->
            <datafield tag="336">
                <subfield code="a" select="lower-case(.)" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
            </datafield>
            <datafield tag="700">
                <subfield code="h" select="lower-case(frbrizer:trim(.))" type="http://rdaregistry.info/Elements/e/P20001" label="has content type"/>
                <subfield code="l" select="lower-case(.)" type="http://rdaregistry.info/Elements/e/P20006" label="has language of expression"/>
                <subfield code="t" select="frbrizer:trim(.)" type="{if (frbrizer:linked-strict($record/*:datafield[@tag='740'], ..)) then 'http://rdaregistry.info/Elements/e/P20316' else 'http://rdaregistry.info/Elements/e/P20315'}"  label="has variant title"/>
            </datafield>
            <datafield tag="740" condition="frbrizer:linked-strict($anchor_field, .)">
                <subfield code="a" select="frbrizer:trim(.)" type="http://rdaregistry.info/Elements/e/P20315" label="has preferred title"/>
            </datafield>
        </attributes>
        <key order="3">
            <element>(frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/e/P20231']/@href))[1]</element>
            <element>'/'</element>
            <element>lower-case((*:datafield[@tag = ('130', '240', '700')]/*:subfield[@type='http://rdaregistry.info/Elements/e/P20006'], *:controlfield[@tag = '008'][@type='http://rdaregistry.info/Elements/e/P20006'])[1])</element>
            <element>'/'</element>
            <element>lower-case((*:datafield/*:subfield[@type='http://rdaregistry.info/Elements/e/P20001']/replace(., ' ', ''))[1])</element>
            <element>'/'</element>
            <element>string-join(frbrizer:trimsort-targets(*:relationship[@type =('http://rdaregistry.info/Elements/e/P20037', 'http://rdaregistry.info/Elements/e/P20022', 'http://rdaregistry.info/Elements/e/P20049')]/@href), '/')</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/e/P20059" itype="http://rdaregistry.info/Elements/m/P30139" label="has manifestation of expression" ilabel="has expression manifested">
                <target entity="MARC21-245-Manifestation"/>
            </relationship>
        </relationships>
    </entity>
    
    <!-- Related work -->
    
    <entity tag="700" condition="not(@ind2 = '2') and *:subfield/@code = 't' and starts-with(*:subfield[@code = '4'], 'http')" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-700-Person-Related-Work" label="Person">
        <note>Person in 700 field related work </note>
        <attributes>
            <datafield tag="700">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="4" type="relator code"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='700'])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/a/P50195" itype="http://rdaregistry.info/Elements/w/P10061">
                <target entity="MARC21-700-Work-Related-Work" same-field="true"/>
            </relationship>
        </relationships>
    </entity>
    
    <entity tag="700" condition="not(@ind2 = '2') and *:subfield/@code = 't' and *:subfield/@code = '4'" type="http://rdaregistry.info/Elements/c/C10001" templatename="MARC21-700-Work-Related-Work" label="Work">
        <note>Related work</note>
        <attributes>
            <datafield tag="700">
                <subfield code="t" type="http://rdaregistry.info/Elements/w/P10088" select="string-join((frbrizer:trim(.), frbrizer:trim(../*:subfield[@code = 'p'])), ' : ')" label="has title of the work"/>
                <subfield code="f" type="http://rdaregistry.info/Elements/w/P10219" label="has date of work"/>
                <subfield code="n" type="http://rdaregistry.info/Elements/w/P10003" label="has other distinguishing characteristic of the work"/>
                <subfield code="k" select="lower-case(.)"  type="http://rdaregistry.info/Elements/w/P10004" label="has form of work"/>
                <subfield code="1w" type="http://rdaregistry.info/Elements/w/P10002" label="has identifier for work"/>
            </datafield>
        </attributes>
        <key order="2">
            <element>frbrizer:create-workid(*:datafield[@tag='700'], frbrizer:sort-relationships(*:relationship[@type = 'http://rdaregistry.info/Elements/w/P10061']/@href)[1])</element>
        </key>
        <relationships>

        </relationships>
    </entity>
    
    <!-- Added entry person only entries with $4 -->
    
    <entity tag="700" code="4" condition="not(*:subfield/@code = 't') and *:subfield/@code = '4'" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-700-Person" label="Person">
        <note>Person in 700 field (the role and relationship for the person is defined using relationship rules)</note>
        <attributes>
            <datafield tag="700">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="4" type="relatorcode"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='700'])</element>
        </key>
        <relationships>
            <relationship condition="$relmap/rels/rel[$this_subfield = k and domain='Work']" type="{$relmap/rels/rel[k = $this_subfield and domain='Work']/reverse}" itype="{$relmap/rels/rel[k = $this_subfield and domain='Work']/forward}">
                <target entity="MARC21-700-Work-Analytical" condition="frbrizer:linked($anchor_field, $target_field)"  same-field="false"/>
                <target entity="MARC21-130240-Work"/>
            </relationship>
            <relationship condition="$relmap/rels/rel[$this_subfield = k and domain='Expression']" type="{$relmap/rels/rel[k = $this_subfield and domain='Expression']/reverse}" itype="{$relmap/rels/rel[k = $this_subfield and domain='Expression']/forward}">
                <target entity="MARC21-700-Expression-Analytical"  condition="frbrizer:linked($anchor_field, $target_field)"  same-field="false"/>
                <target entity="MARC21-130240-Expression"/>
            </relationship>
            <relationship condition="$relmap/rels/rel[$this_subfield = k and domain='Manifestation']" type="{$relmap/rels/rel[k = $this_subfield and domain='Manifestation']/reverse}" itype="{$relmap/rels/rel[k = $this_subfield and domain='Manifestation']/forward}">
                <target entity="MARC21-245-Manifestation" condition="frbrizer:linked($anchor_field, $target_field)"  same-field="false"/>
            </relationship>
        </relationships>
    </entity>
    
    <!-- Added entry person only entries without $4 are all related to 130/240 expression -->
    
    <entity tag="700" condition="not(*:subfield/@code = '4') and not(*:subfield/@code = 't')" type="http://rdaregistry.info/Elements/c/C10004" templatename="MARC21-700-Person-Unspecified-relation" label="Person">
        <note>Person in 700 field (the role and relationship for the person is defined using relationship rules)</note>
        <attributes>
            <datafield tag="700">
                <subfield code="a" type="http://rdaregistry.info/Elements/a/P50111" select="frbrizer:trim(.)" label="has name of the person"/>
                <subfield code="d" type="http://rdaregistry.info/Elements/a/P50107" select="frbrizer:trim(.)" label="has date associated with the person"/>
                <subfield code="4" type="relatorcode"/>
                <subfield code="1p" type="http://rdaregistry.info/Elements/a/P50094" label="has identifier for person"/>
            </datafield>
        </attributes>
        <key order="1">
            <element>frbrizer:create-personid(*:datafield[@tag='700'])</element>
        </key>
        <relationships>
            <relationship type="http://rdaregistry.info/Elements/a/P50161" itype="http://rdaregistry.info/Elements/e/P20053">
                <target entity="MARC21-130240-Expression"/>
            </relationship>
        </relationships>
    </entity>

    
    <stylesheet xmlns:frbrizer="http://idi.ntnu.no/frbrizer/" xmlns:xs="http://www.w3.org/2001/XMLSchema" version="2.0">
        
        <xsl:function xmlns:local="http://idi.ntnu.no/frbrizer/"
            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
            xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
            name="local:create-personid">
            <xsl:param name="datafield"/>
            <xsl:choose>
                <xsl:when test="$datafield/*:subfield[@code = '1p']">
                    <xsl:value-of select="($datafield/*:subfield[@code = '1p'])[1]"/>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:value-of select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'b'], $datafield/*:subfield[@code = 'c'], $datafield/*:subfield[@code = 'd']), '')), '[^A-Za-z0-9]', '')"/>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:function>
        
        <xsl:function xmlns:local="http://idi.ntnu.no/frbrizer/"
            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
            xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
            name="local:create-workid">
            <xsl:param name="datafield"/>
            <xsl:param name="relationship"/>
            <xsl:choose>
                <xsl:when test="$datafield/*:subfield[@code = '1w']">
                    <xsl:value-of select="($datafield/*:subfield[@code = '1w'])[1]"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag='130']">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'k'], $datafield/*:subfield[@code = 'n'], $datafield/*:subfield[@code = 'o'], $datafield/*:subfield[@code = 'p']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag='240']">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'k'], $datafield/*:subfield[@code = 'n'], $datafield/*:subfield[@code = 'o'], $datafield/*:subfield[@code = 'p']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag='245']">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 'a'], $datafield/*:subfield[@code = 'b']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:when test="$datafield[@tag=('600', '700', '800')]">
                    <xsl:variable name="value" select="replace(lower-case(string-join(($datafield/*:subfield[@code = 't'], $datafield/*:subfield[@code = 'k'], $datafield/*:subfield[@code = 'n'], $datafield/*:subfield[@code = 'o'], $datafield/*:subfield[@code = 'p']), '')), '[^A-Za-z0-9]', '')"/>
                    <xsl:value-of select="$relationship||'/'||$value"/>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:value-of select="$relationship||'/noidentifier'"/>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:function>
        
        <xsl:function name="frbrizer:linked" as="xs:boolean">
            <!-- returns true if the two fields have the same marc 21 link ($8), or if there is no linking subfields in target or source -->
            <xsl:param name="anchor" as="element()"/>
            <xsl:param name="target" as="element()"/>
            <xsl:value-of select="(some $x in $anchor/*:subfield[@code = '8'] satisfies $x = $target/*:subfield[@code = '8']) or (not(exists($anchor/*:subfield[@code = '8'])) or not(exists($target/*:subfield[@code='8'])))"/>  
            <!--xsl:value-of select="(some $x in $anchor/*:subfield[@code = '8'] satisfies $x = $target/*:subfield[@code = '8']) or (not(exists($target/*:subfield[@code = '8'])))"/>-->
        </xsl:function>
        
        <xsl:function name="frbrizer:linked-strict" as="xs:boolean">
            <!-- returns true if the two fields have the same marc 21 link ($8) -->
            <xsl:param name="anchor" as="element()*"/>
            <xsl:param name="target" as="element()*"/>
            <xsl:value-of select="some $x in $anchor/*:subfield[@code = '8'] satisfies $x = $target/*:subfield[@code = '8']"/>
        </xsl:function>
        
        <xsl:function name="frbrizer:trim" as="xs:string*">
            <xsl:param name="value" as="element()*"/>
            <xsl:for-each select="$value">
                <xsl:value-of select="replace(., '[ \.,/:]+$', '')"/>
            </xsl:for-each>
        </xsl:function>
        <xsl:function name="frbrizer:idprefix">
            <xsl:param name="value"/>
            <xsl:choose>
                <xsl:when test="$value = '0'">
                    <xsl:value-of select="'isrc'"/>
                </xsl:when>
                <xsl:when test="$value = '1'">
                    <xsl:value-of select="'upc'"/>
                </xsl:when>
                <xsl:when test="$value = '2'">
                    <xsl:value-of select="'ismn'"/>
                </xsl:when>
                <xsl:when test="$value = '3'">
                    <xsl:value-of select="'ian'"/>
                </xsl:when>
                <xsl:when test="$value = '4'">
                    <xsl:value-of select="'sici'"/>
                </xsl:when>
                <xsl:otherwise>
                    <xsl:value-of select="'unknown'"/>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:function>

        <xsl:variable name="relmap" select="doc('relationships.xml')"/>
        
    </stylesheet>
</templates>

